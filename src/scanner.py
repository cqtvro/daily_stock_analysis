# src/scanner.py
# ç°ä»£æœåŠ¡ä¸“å± - å…¨å¸‚åœºæ‰«ææ¢å¤´
import akshare as ak
import pandas as pd

def scan_for_destruction(limit=3):
    """
    ã€ç¾éš¾æ‰«ææ¨¡å¼ã€‘
    å¯»æ‰¾å¸‚åœºä¸Šâ€œæ­»ä¼¤æœ€æƒ¨é‡â€çš„æ ·æœ¬ï¼š
    1. è·Œå¹… > 3% (çœŸçš„åœ¨è·Œ)
    2. æ¢æ‰‹ç‡ > 5% (æœ‰äººåœ¨ç–¯ç‹‚å‡ºé€ƒ)
    3. é‡æ¯” > 1.5 (æ”¾é‡ä¸‹è·Œï¼Œç¡®è®¤ä¸ºææ…Œç›˜)
    """
    print("ğŸ“¡ [ç°ä»£æœåŠ¡] æ­£åœ¨å¯åŠ¨å…¨é¢‘æ®µæ‰«æï¼Œå¯»æ‰¾ç”±äºè¿‡è½½å¯¼è‡´çš„çƒ§æœºæ ·æœ¬...")
    
    try:
        # 1. è·å–å…¨å¸‚åœºå®æ—¶è¡Œæƒ… (ç›¸å½“äºé¢‘è°±ä»ªå…¨å¼€)
        df = ak.stock_zh_a_spot_em()
        
        # 2. è¿‡æ»¤æ‰åŒ—äº¤æ‰€å’ŒST (æ»¤é™¤ä½é¢‘å™ªéŸ³)
        # æ’é™¤ 8xxx, 4xxx å¼€å¤´çš„ï¼Œæ’é™¤åç§°å« ST
        df = df[~df['ä»£ç '].str.startswith(('8', '4'))]
        df = df[~df['åç§°'].str.contains('ST')]

        # 3. ç¡¬æ ¸ç­›é€‰é€»è¾‘ï¼šæ”¾é‡æ€è·Œ
        # è·Œå¹…å°äº -3%, æ¢æ‰‹ç‡å¤§äº 5%, é‡æ¯”å¤§äº 1.5
        condition = (df['æ¶¨è·Œå¹…'] < -3) & (df['æ¢æ‰‹ç‡'] > 5) & (df['é‡æ¯”'] > 1.5)
        panic_stocks = df[condition]

        # 4. æŒ‰ä¸»åŠ›èµ„é‡‘å‡€æµå‡ºæ’åº (è°æµå‡ºå¤šæŠ“è°)
        # æ³¨æ„ï¼šè¿™é‡Œç”¨æˆäº¤é¢æš‚ä»£ï¼ŒAkShare å®æ—¶æµå‡ºæ¥å£è¾ƒæ…¢ï¼Œç”¨æˆäº¤é¢+å¤§è·Œè¿‘ä¼¼åˆ¤æ–­ä¸»åŠ›å‡ºé€ƒ
        panic_stocks = panic_stocks.sort_values(by='æˆäº¤é¢', ascending=False)

        # 5. å–å‰ N å
        top_burners = panic_stocks.head(limit)
        
        results = []
        for index, row in top_burners.iterrows():
            # æ ¼å¼åŒ–ä¸ºç³»ç»Ÿèƒ½è¯†åˆ«çš„ä»£ç  (å¦‚ 600519)
            code = row['ä»£ç ']
            name = row['åç§°']
            change = row['æ¶¨è·Œå¹…']
            print(f"   âš ï¸ é”å®šç›®æ ‡: {name}({code}) è·Œå¹…:{change}% - ç¡®è®¤è¿‡è½½")
            results.append(code)
            
        return results

    except Exception as e:
        print(f"âŒ æ‰«ææ¢å¤´æ•…éšœ: {e}")
        return []

# ä¹Ÿå¯ä»¥åŠ ä¸€ä¸ªâ€œå¦–è‚¡æ‰«æâ€é€»è¾‘ï¼Œçœ‹è°åœ¨è¯±å¤š
def scan_for_noise(limit=2):
    """
    ã€å™ªéŸ³æ‰«ææ¨¡å¼ã€‘
    å¯»æ‰¾è«åå…¶å¦™æ¶¨åœçš„ç¥¨ï¼Œä½œä¸ºâ€œè¯±å¤šâ€è§‚å¯Ÿæ ·æœ¬
    """
    # ... (é€»è¾‘ç±»ä¼¼ï¼Œæ”¹ç­›é€‰æ¡ä»¶å³å¯) ...
    return []
